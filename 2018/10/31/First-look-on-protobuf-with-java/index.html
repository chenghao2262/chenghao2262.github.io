<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  

  
  <title>First look on protobuf with java | 昊学</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="protobuf 性质速览proto2protobuf语法分为proto2和proto3，此处只介绍proto2的语法。 Messageprotobuf数据以message为单元12345message SearchRequest &amp;#123;  required string query = 1;  optional int32 page_number = 2;  optional int32">
<meta name="keywords" content="java,protobuf,code">
<meta property="og:type" content="article">
<meta property="og:title" content="First look on protobuf with java">
<meta property="og:url" content="http://yoursite.com/2018/10/31/First-look-on-protobuf-with-java/index.html">
<meta property="og:site_name" content="昊学">
<meta property="og:description" content="protobuf 性质速览proto2protobuf语法分为proto2和proto3，此处只介绍proto2的语法。 Messageprotobuf数据以message为单元12345message SearchRequest &amp;#123;  required string query = 1;  optional int32 page_number = 2;  optional int32">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2018-11-06T09:56:57.952Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="First look on protobuf with java">
<meta name="twitter:description" content="protobuf 性质速览proto2protobuf语法分为proto2和proto3，此处只介绍proto2的语法。 Messageprotobuf数据以message为单元12345message SearchRequest &amp;#123;  required string query = 1;  optional int32 page_number = 2;  optional int32">
  
    <link rel="alternate" href="/atom.xml" title="昊学" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
</head>
</html>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">昊学</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-First-look-on-protobuf-with-java" class="article article-type-post" itemscope="" itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/10/31/First-look-on-protobuf-with-java/" class="article-date">
  <time datetime="2018-10-31T09:50:23.000Z" itemprop="datePublished">2018-10-31</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      First look on protobuf with java
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="protobuf-性质速览"><a href="#protobuf-性质速览" class="headerlink" title="protobuf 性质速览"></a>protobuf 性质速览</h1><h2 id="proto2"><a href="#proto2" class="headerlink" title="proto2"></a>proto2</h2><p>protobuf语法分为proto2和proto3，此处只介绍proto2的语法。</p>
<h3 id="Message"><a href="#Message" class="headerlink" title="Message"></a>Message</h3><p>protobuf数据以message为单元<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">message SearchRequest &#123;</span><br><span class="line">  required string query = 1;</span><br><span class="line">  optional int32 page_number = 2;</span><br><span class="line">  optional int32 result_per_page = 3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>message每条filed由以下构成<br>rules type name = number;[option]<br>rules 用来限定该filed属性</p>
<ul>
<li>required</li>
<li>optional</li>
<li>repeated</li>
</ul>
<p>required表示一定需要该filed。<br>optional表示可选filed。可以设置optional的默认值，如果未设置，protobuf会依据filed的type设置默认的默认值。（实际上在parse过程中，protobuf会为optional filed设置一个默认值）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">optional int32 result_per_page = 3 [default = 10];</span><br></pre></td></tr></table></figure></p>
<p>repeated表示可重复filed。</p>
<p>type 描述该filed类型</p>
<ul>
<li>scalar type</li>
<li>message</li>
<li>enumeration</li>
</ul>
<p>name表示该filed名字<br>number用来在message binary format中标识该filed</p>
<p>reversed filed<br>当你将旧有的filed删除或注释掉的之后，添加新的filed使用旧有number，这看起来似乎没有什么问题，但当你的程序读取旧数据则会产生data corruption等问题。为了避免这种情况，推荐将不再使用的filed设置成为reversed。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">message Foo &#123;</span><br><span class="line">  reserved 2, 15, 9 to 11;</span><br><span class="line">  reserved &quot;foo&quot;, &quot;bar&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="import"><a href="#import" class="headerlink" title="import"></a>import</h3><p>当你需要使用其他文件定义的message，先import该message所在的文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;myproject/other_protos.proto&quot;;</span><br></pre></td></tr></table></figure></p>
<p>默认情况下，你只能引用在该文件中定义的类型。如果你想使用，引用文件中引用的类型，请在引用文件中使用import public。这么说可能过于复杂，设想以下情景。当你决定移动某个proto文件，而不想逐一修改引用该proto文件的引用语句，可以这样操作。将proto文件移动到new_proto文件，在old_proto文件中使用import pulic来引用new_proto。<br>你需要给protocol compiler添加<strong>-I/–proto_path</strong>参数来表示proto文件所在路径，默认情况下会是compiler被调用的路径。</p>
<h3 id="scalar-value-types"><a href="#scalar-value-types" class="headerlink" title="scalar value types"></a>scalar value types</h3><p>protobuf支持的原生type。<a href="https://developers.google.com/protocol-buffers/docs/proto#Scalar%20Value%20Types" target="_blank" rel="noopener">scalar types</a></p>
<h3 id="Enumerations"><a href="#Enumerations" class="headerlink" title="Enumerations"></a>Enumerations</h3><p>类似于java中的enumeration，你可以将其定义在message中也可以定义在message外，如果你想使用其他message中的enum，使用这种写法MessageType.EnumType。注意：enum的数值常量应在32bit以内。由于enum使用变长编码，负数值会造成低效率故不推荐。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">message SearchRequest &#123;</span><br><span class="line">  required string query = 1;</span><br><span class="line">  optional int32 page_number = 2;</span><br><span class="line">  optional int32 result_per_page = 3 [default = 10];</span><br><span class="line">  enum Corpus &#123;</span><br><span class="line">    UNIVERSAL = 0;</span><br><span class="line">    WEB = 1;</span><br><span class="line">    IMAGES = 2;</span><br><span class="line">    LOCAL = 3;</span><br><span class="line">    NEWS = 4;</span><br><span class="line">    PRODUCTS = 5;</span><br><span class="line">    VIDEO = 6;</span><br><span class="line">  &#125;</span><br><span class="line">  optional Corpus corpus = 4 [default = UNIVERSAL];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>同样你也可以将enum的value设为保留值，以避免读取旧数据时产生问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">enum Foo &#123;</span><br><span class="line">  reserved 2, 15, 9 to 11, 40 to max;</span><br><span class="line">  reserved &quot;FOO&quot;, &quot;BAR&quot;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="nested-types"><a href="#nested-types" class="headerlink" title="nested types"></a>nested types</h3><p>除了在message内部定义enum，你也可以在message内部定义message。如果你想在外部使用该message，使用这种语法Parent.Type。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">message SearchResponse &#123;</span><br><span class="line">  message Result &#123;</span><br><span class="line">    required string url = 1;</span><br><span class="line">    optional string title = 2;</span><br><span class="line">    repeated string snippets = 3;</span><br><span class="line">  &#125;</span><br><span class="line">  repeated Result result = 1;</span><br><span class="line">&#125;</span><br><span class="line">message SomeOtherMessage &#123;</span><br><span class="line">  optional SearchResponse.Result result = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h3><p>你可以在message内部声明一个一段数字作为extension保留。允许其他proto给该message添加新filed。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">message Foo &#123;</span><br><span class="line">  // ...</span><br><span class="line">  extensions 100 to 199;</span><br><span class="line">&#125;</span><br><span class="line">extend Foo &#123;</span><br><span class="line">  optional int32 bar = 126;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>虽然Foo编码后，其wire format同定义了一个新的filed的Foo相同，但是代码内访问该filed和访问普通filed有些不同。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Foo foo;</span><br><span class="line">foo.SetExtension(bar, 15);</span><br></pre></td></tr></table></figure></p>
<p>可以在message内部定义一个extension<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message Baz &#123;</span><br><span class="line">  extend Foo &#123;</span><br><span class="line">    optional int32 bar = 126;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>它需要这样访问（c++code）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Foo foo;</span><br><span class="line">foo.SetExtension(Baz::bar, 15);</span><br></pre></td></tr></table></figure></p>
<p>当然有个有趣的操作就是，你可以在定义一个extension在其本身中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message Baz &#123;</span><br><span class="line">  extend Foo &#123;</span><br><span class="line">    optional Baz foo_ext = 127;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>这或许有些难以理解，其实这和以下等效。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">message Baz &#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// This can even be in a different file.</span><br><span class="line">extend Foo &#123;</span><br><span class="line">  optional Baz foo_baz_ext = 127;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Oneof"><a href="#Oneof" class="headerlink" title="Oneof"></a>Oneof</h3><p>如果你有一些optional filed，同时很明确这些filed同时最多只有一个能被设置。你可以使用<strong>oneof</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message SampleMessage &#123;</span><br><span class="line">  oneof test_oneof &#123;</span><br><span class="line">     string name = 4;</span><br><span class="line">     SubMessage sub_message = 9;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>注意，oneof不能使用rules词（optional、required和repeated）修饰。如果我想repeated怎么办？把oneof的某个filed设为包含repeated filed的message type。<br>当你尝试给oneof设置值时，会清除其前一个值。<br>在c++中请小心使用，因为你很可能持有旧有引用而引起问题。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SampleMessage message;</span><br><span class="line">SubMessage* sub_message = message.mutable_sub_message();</span><br><span class="line">message.set_name(&quot;name&quot;);      // Will delete sub_message</span><br><span class="line">sub_message-&gt;set_...            // Crashes here</span><br></pre></td></tr></table></figure></p>
<h3 id="Maps"><a href="#Maps" class="headerlink" title="Maps"></a>Maps</h3><p>map类型定义如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">map&lt;key_type, value_type&gt; map_field = N;</span><br></pre></td></tr></table></figure></p>
<p>key_type可以是任意integer或者string类型，所以除float point类型和bytes类型外的其他任何scalar类型均可以做为key_type.<br>注意</p>
<ul>
<li>不支持extension</li>
<li>不支持repeated，optional和required</li>
<li>wire format 顺序和map迭代顺序并未定义，因此你不能依赖map item顺序</li>
<li>生成的text format中，maps会按key排序。</li>
<li>当解析wire format时，如果出现重复key，则会以最后一个为准，但是解析text format，重复key会出错。</li>
</ul>
<p>兼容性，对于不支持map的protobuf实现，会议以下方式处理map。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">message MapFieldEntry &#123;</span><br><span class="line">  optional key_type key = 1;</span><br><span class="line">  optional value_type value = 2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">repeated MapFieldEntry map_field = N;</span><br></pre></td></tr></table></figure></p>
<h3 id="Packages"><a href="#Packages" class="headerlink" title="Packages"></a>Packages</h3><p>使用package来避免.proto的命名冲突。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">package foo.bar;</span><br><span class="line">message Open &#123; ... &#125;</span><br></pre></td></tr></table></figure></p>
<p>可以这样使用Open<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">message Foo &#123;</span><br><span class="line">  ...</span><br><span class="line">  required foo.bar.Open open = 1;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Services"><a href="#Services" class="headerlink" title="Services"></a>Services</h3><p>如果你想在RPC中使用你的message类型，你可以在.proto文件中定义RPC service interface接口。随后protobuf compiler会自动根据你的语言生产服务接口代码和桩代码。比如你想创建一个使用SearchRequest和SearchResponse的RPC服务，你可以做出如下定义。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service SearchService &#123;</span><br><span class="line">  rpc Search (SearchRequest) returns (SearchResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="Options"><a href="#Options" class="headerlink" title="Options"></a>Options</h3><p>java常用option</p>
<ul>
<li>java_package (file option) 定义生产代码所在包</li>
<li>java_outer_classname (file option) 定义生成代码类名</li>
<li>optimize_for (file option)： 优化方式</li>
</ul>
<h2 id="proto3"><a href="#proto3" class="headerlink" title="proto3"></a>proto3</h2><p>tbd</p>
<h2 id="Encoding"><a href="#Encoding" class="headerlink" title="Encoding"></a>Encoding</h2><p>涉及底层编码方式<br>tbd</p>
<h2 id="protobuf-for-JAVA"><a href="#protobuf-for-JAVA" class="headerlink" title="protobuf for JAVA"></a>protobuf for JAVA</h2><p>简单定义一个person.proto<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto2&quot;;</span><br><span class="line"></span><br><span class="line">package tutorial;</span><br><span class="line"></span><br><span class="line">option java_package = &quot;com.example.tutorial&quot;;</span><br><span class="line">option java_outer_classname = &quot;AddressBookProtos&quot;;</span><br><span class="line"></span><br><span class="line">message Person &#123;</span><br><span class="line">  required string name = 1;</span><br><span class="line">  required int32 id = 2;</span><br><span class="line">  optional string email = 3;</span><br><span class="line"></span><br><span class="line">  enum PhoneType &#123;</span><br><span class="line">    MOBILE = 0;</span><br><span class="line">    HOME = 1;</span><br><span class="line">    WORK = 2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  message PhoneNumber &#123;</span><br><span class="line">    required string number = 1;</span><br><span class="line">    optional PhoneType type = 2 [default = HOME];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  repeated PhoneNumber phones = 4;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">message AddressBook &#123;</span><br><span class="line">  repeated Person people = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>生成java code，可以使用command-line<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protoc -I=$SRC_DIR --java_out=$DST_DIR $SRC_DIR/addressbook.proto</span><br></pre></td></tr></table></figure></p>
<p>如果使用maven,maven可以自动帮你生成相应代码。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.google.protobuf&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;protobuf-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.5.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">...</span><br><span class="line">&lt;plugin&gt;</span><br><span class="line">    &lt;groupId&gt;org.xolstice.maven.plugins&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;protobuf-maven-plugin&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;0.5.0&lt;/version&gt;</span><br><span class="line">    &lt;configuration&gt;</span><br><span class="line">        &lt;protocExecutable&gt;protoc&lt;/protocExecutable&gt;</span><br><span class="line">        &lt;protoSourceRoot&gt;$&#123;basedir&#125;/protobuf&lt;/protoSourceRoot&gt;</span><br><span class="line">    &lt;/configuration&gt;</span><br><span class="line">    &lt;executions&gt;</span><br><span class="line">        &lt;execution&gt;</span><br><span class="line">            &lt;goals&gt;</span><br><span class="line">                &lt;goal&gt;compile&lt;/goal&gt;</span><br><span class="line">            &lt;/goals&gt;</span><br><span class="line">        &lt;/execution&gt;</span><br><span class="line">    &lt;/executions&gt;</span><br><span class="line">&lt;/plugin&gt;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Serializer code</span></span><br><span class="line">Person john =</span><br><span class="line">        Person.newBuilder()</span><br><span class="line">                .setId(<span class="number">1234</span>)</span><br><span class="line">                .setName(<span class="string">"John Doe"</span>)</span><br><span class="line">                .setEmail(<span class="string">"jdoe@example.com"</span>)</span><br><span class="line">                .addPhones(Person.PhoneNumber.newBuilder()</span><br><span class="line">                                .setNumber(<span class="string">"555-4321"</span>)</span><br><span class="line">                                .setType(Person.PhoneType.HOME))</span><br><span class="line">                .build();</span><br><span class="line"></span><br><span class="line">Person kulisu =</span><br><span class="line">        Person.newBuilder()</span><br><span class="line">                .setId(<span class="number">1000</span>)</span><br><span class="line">                .setName(<span class="string">"kulisu"</span>)</span><br><span class="line">                .setEmail(<span class="string">"Kulisu@outlook.com"</span>)</span><br><span class="line">                .addPhones(Person.PhoneNumber.newBuilder()</span><br><span class="line">                        .setNumber(<span class="string">"173xxxx8086"</span>)</span><br><span class="line">                        .setType(Person.PhoneType.MOBILE))</span><br><span class="line">                .build();</span><br><span class="line">AddressBook addressBook =</span><br><span class="line">        AddressBook.newBuilder()</span><br><span class="line">                    .addPeople(john)</span><br><span class="line">                    .addPeople(kulisu)</span><br><span class="line">                    .build();</span><br><span class="line">File file = <span class="keyword">new</span> File(<span class="string">"person.data"</span>);</span><br><span class="line"><span class="keyword">try</span> (FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(file)) &#123;</span><br><span class="line">    addressBook.writeTo(fileOutputStream);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// parser code</span></span><br><span class="line"></span><br><span class="line">File file = <span class="keyword">new</span> File(<span class="string">"person.data"</span>);</span><br><span class="line"><span class="keyword">try</span> (FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(file)) &#123;</span><br><span class="line">    AddressBook addressBook = AddressBook.parseFrom(fileInputStream);</span><br><span class="line">    <span class="keyword">for</span> (Person person: addressBook.getPeopleList()) &#123;</span><br><span class="line">        System.out.println(<span class="string">"Person ID: "</span> + person.getId());</span><br><span class="line">        System.out.println(<span class="string">"  Name: "</span> + person.getName());</span><br><span class="line">        <span class="keyword">if</span> (person.hasEmail()) &#123;</span><br><span class="line">            System.out.println(<span class="string">"  E-mail address: "</span> + person.getEmail());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (Person.PhoneNumber phoneNumber : person.getPhonesList()) &#123;</span><br><span class="line">            <span class="keyword">switch</span> (phoneNumber.getType()) &#123;</span><br><span class="line">                <span class="keyword">case</span> MOBILE:</span><br><span class="line">                    System.out.print(<span class="string">"  Mobile phone #: "</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> HOME:</span><br><span class="line">                    System.out.print(<span class="string">"  Home phone #: "</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                <span class="keyword">case</span> WORK:</span><br><span class="line">                    System.out.print(<span class="string">"  Work phone #: "</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(phoneNumber.getNumber());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Person ID: 1234</span><br><span class="line">  Name: John Doe</span><br><span class="line">  E-mail address: jdoe@example.com</span><br><span class="line">  Home phone #: 555-4321</span><br><span class="line">Person ID: 1000</span><br><span class="line">  Name: Kulisu</span><br><span class="line">  E-mail address: Kulisu@outlook.com</span><br><span class="line">  Mobile phone #: 173xxxx8086</span><br></pre></td></tr></table></figure></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/10/31/First-look-on-protobuf-with-java/" data-id="cjofx2cbr000f9q2gub7viiyt" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/code/">code</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/java/">java</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/protobuf/">protobuf</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2018/11/01/java-多线程学习笔记（一）入门/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          java 多线程学习笔记（一）入门
        
      </div>
    </a>
  
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/java多线程学习笔记/">java多线程学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/netty学习笔记/">netty学习笔记</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/杂记/">杂记</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/code/">code</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/netty/">netty</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/protobuf/">protobuf</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/synchronized/">synchronized</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/code/" style="font-size: 10px;">code</a> <a href="/tags/java/" style="font-size: 20px;">java</a> <a href="/tags/netty/" style="font-size: 10px;">netty</a> <a href="/tags/protobuf/" style="font-size: 10px;">protobuf</a> <a href="/tags/synchronized/" style="font-size: 10px;">synchronized</a> <a href="/tags/多线程/" style="font-size: 15px;">多线程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">十一月 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/10/">十月 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/11/05/netty-学习笔记（一）/">netty 学习笔记（一）</a>
          </li>
        
          <li>
            <a href="/2018/11/03/Java-多线程学习笔记-后记/">Java 多线程学习笔记 后记</a>
          </li>
        
          <li>
            <a href="/2018/11/03/Java-多线程学习笔记（三）进阶/">Java 多线程学习笔记（三）进阶</a>
          </li>
        
          <li>
            <a href="/2018/11/02/双十一购书清单/">双十一购书清单</a>
          </li>
        
          <li>
            <a href="/2018/11/01/Java-多线程学习笔记（二）基础/">Java 多线程学习笔记（二）基础</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 Cheng Hao<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>



  </div>
</body>
</html>